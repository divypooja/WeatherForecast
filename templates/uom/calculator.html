{% extends "base.html" %}

{% block title %}UOM Calculator - AK Innovations{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('uom.dashboard') }}">UOM Management</a></li>
                    <li class="breadcrumb-item active">Calculator</li>
                </ol>
            </nav>
            <h2><i class="fas fa-calculator"></i> UOM Conversion Calculator</h2>
            <p class="text-muted">Test conversions between different units for specific items</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Conversion Calculator</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form.item.label(class="form-label") }}
                                    {{ form.item(class="form-select", **{"onchange": "updateConversionInfo()"}) }}
                                    {% if form.item.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.item.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.quantity.label(class="form-label") }}
                                    {{ form.quantity(class="form-control", **{"oninput": "calculateResult()"}) }}
                                    {% if form.quantity.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.quantity.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.from_unit.label(class="form-label") }}
                                    {{ form.from_unit(class="form-select", **{"onchange": "calculateResult()"}) }}
                                    {% if form.from_unit.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.from_unit.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.to_unit.label(class="form-label") }}
                                    {{ form.to_unit(class="form-select", **{"onchange": "calculateResult()"}) }}
                                    {% if form.to_unit.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.to_unit.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-center mb-4">
                            {{ form.calculate(class="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                    
                    <!-- Result Display -->
                    {% if result %}
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> Conversion Result</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Input:</strong> {{ result.input_quantity }} {{ result.from_unit_name }}
                            </div>
                            <div class="col-md-6">
                                <strong>Output:</strong> {{ result.output_quantity }} {{ result.to_unit_name }}
                            </div>
                        </div>
                        <div class="mt-2 small text-muted">
                            <strong>Item:</strong> {{ result.item_name }} | 
                            <strong>Conversion Factor:</strong> {{ result.conversion_factor }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Item Conversion Info -->
                    <div id="conversionInfo" class="card bg-light" style="display: none;">
                        <div class="card-body">
                            <h6><i class="fas fa-info-circle"></i> Item Conversion Information</h6>
                            <div id="conversionDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Examples -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6><i class="fas fa-lightbulb"></i> Quick Examples</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <strong>Books Example:</strong>
                                <br>
                                <small class="text-muted">
                                    Buy: 1 Kg → Stock: 1 Kg → Sell: 40 Pcs
                                    <br>Each book weighs 25g
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <strong>Medicine Example:</strong>
                                <br>
                                <small class="text-muted">
                                    Buy: 1 Kg → Stock: 1 Kg → Sell: 100 Pcs
                                    <br>Each tablet weighs 10g
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <strong>Gold Jewelry Example:</strong>
                                <br>
                                <small class="text-muted">
                                    Buy: 1 Kg → Stock: 1 Kg → Sell: 2 Pcs
                                    <br>Each piece weighs 500g
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateConversionInfo() {
    const itemSelect = document.getElementById('item');
    const selectedItemId = itemSelect.value;
    
    if (selectedItemId) {
        // Make AJAX call to get item conversion info
        fetch(`/uom/api/item-uom-info/${selectedItemId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const conversionInfo = document.getElementById('conversionInfo');
                    const conversionDetails = document.getElementById('conversionDetails');
                    
                    conversionDetails.innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Purchase Unit:</strong><br>
                                <span class="badge bg-success">${data.purchase_unit}</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Inventory Unit:</strong><br>
                                <span class="badge bg-warning">${data.inventory_unit}</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Sale Unit:</strong><br>
                                <span class="badge bg-info">${data.sale_unit}</span>
                            </div>
                        </div>
                        ${data.weight_per_piece ? `
                        <div class="mt-2">
                            <strong>Weight per piece:</strong> ${data.weight_per_piece} Kg
                        </div>
                        ` : ''}
                    `;
                    
                    conversionInfo.style.display = 'block';
                } else {
                    document.getElementById('conversionInfo').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching item info:', error);
                document.getElementById('conversionInfo').style.display = 'none';
            });
    } else {
        document.getElementById('conversionInfo').style.display = 'none';
    }
}

function calculateResult() {
    // This could be enhanced with real-time calculation
    // For now, we rely on form submission
}
</script>
{% endblock %}