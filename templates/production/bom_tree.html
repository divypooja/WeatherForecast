{% extends "base.html" %}

{% block title %}BOM Tree View{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">BOM Tree View</h2>
                <div>
                    <a href="{{ url_for('production.bom_list') }}" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i> BOM List
                    </a>
                    <a href="{{ url_for('production.create_bom') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> New BOM
                    </a>
                </div>
            </div>

            <!-- BOM Tree Structure -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sitemap"></i> Bill of Materials Tree Structure
                    </h5>
                </div>
                <div class="card-body">
                    <div id="bom-tree-container">
                        <!-- Tree will be loaded here via JavaScript -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading BOM tree...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading BOM tree structure...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOM Details Panel -->
            <div class="card mt-4" id="bom-details-panel" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> BOM Details
                    </h5>
                </div>
                <div class="card-body" id="bom-details-content">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bom-tree {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.bom-node {
    margin: 5px 0;
    padding: 8px 12px;
    background: white;
    border-radius: 4px;
    border-left: 4px solid #007bff;
    cursor: pointer;
    transition: all 0.3s ease;
}

.bom-node:hover {
    background: #e3f2fd;
    border-left-color: #1976d2;
}

.bom-node.selected {
    background: #bbdefb;
    border-left-color: #0d47a1;
}

.bom-indent-1 { margin-left: 20px; }
.bom-indent-2 { margin-left: 40px; }
.bom-indent-3 { margin-left: 60px; }
.bom-indent-4 { margin-left: 80px; }

.bom-item-code {
    font-weight: bold;
    color: #1976d2;
}

.bom-item-name {
    color: #424242;
    margin-left: 10px;
}

.bom-quantity {
    float: right;
    background: #e8f5e8;
    color: #2e7d32;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85em;
}

.tree-icon {
    margin-right: 8px;
    color: #666;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadBOMTree();
});

function loadBOMTree() {
    fetch('/api/production/bom-tree')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderBOMTree(data.tree);
            } else {
                showError('Failed to load BOM tree: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading BOM tree:', error);
            showError('Failed to load BOM tree. Please try again.');
        });
}

function renderBOMTree(treeData) {
    const container = document.getElementById('bom-tree-container');
    
    if (!treeData || treeData.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No BOM data found</h5>
                <p class="text-muted">Create your first BOM to see the tree structure.</p>
                <a href="{{ url_for('production.create_bom') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create BOM
                </a>
            </div>
        `;
        return;
    }

    let html = '<div class="bom-tree">';
    treeData.forEach(node => {
        html += renderBOMNode(node, 0);
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function renderBOMNode(node, level) {
    const indentClass = level > 0 ? `bom-indent-${Math.min(level, 4)}` : '';
    const icon = node.children && node.children.length > 0 ? 'fas fa-folder-open' : 'fas fa-file-alt';
    
    let html = `
        <div class="bom-node ${indentClass}" onclick="selectBOM('${node.bom_code}')">
            <i class="${icon} tree-icon"></i>
            <span class="bom-item-code">${node.bom_code}</span>
            <span class="bom-item-name">${node.item_name}</span>
            <span class="bom-quantity">${node.quantity} ${node.uom}</span>
        </div>
    `;
    
    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            html += renderBOMNode(child, level + 1);
        });
    }
    
    return html;
}

function selectBOM(bomCode) {
    // Remove previous selection
    document.querySelectorAll('.bom-node.selected').forEach(node => {
        node.classList.remove('selected');
    });
    
    // Add selection to clicked node
    event.target.closest('.bom-node').classList.add('selected');
    
    // Load BOM details
    loadBOMDetails(bomCode);
}

function loadBOMDetails(bomCode) {
    fetch(`/api/production/bom/${bomCode}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showBOMDetails(data.bom);
            } else {
                showError('Failed to load BOM details: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading BOM details:', error);
            showError('Failed to load BOM details. Please try again.');
        });
}

function showBOMDetails(bom) {
    const panel = document.getElementById('bom-details-panel');
    const content = document.getElementById('bom-details-content');
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>BOM Information</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>BOM Code:</strong></td>
                        <td>${bom.bom_code}</td>
                    </tr>
                    <tr>
                        <td><strong>Item:</strong></td>
                        <td>${bom.item_name}</td>
                    </tr>
                    <tr>
                        <td><strong>Quantity:</strong></td>
                        <td>${bom.quantity} ${bom.uom}</td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td><span class="badge bg-${bom.is_active ? 'success' : 'secondary'}">${bom.is_active ? 'Active' : 'Inactive'}</span></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Cost Breakdown</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Material Cost:</strong></td>
                        <td>₹${bom.material_cost || '0.00'}</td>
                    </tr>
                    <tr>
                        <td><strong>Labor Cost:</strong></td>
                        <td>₹${bom.labor_cost || '0.00'}</td>
                    </tr>
                    <tr>
                        <td><strong>Overhead Cost:</strong></td>
                        <td>₹${bom.overhead_cost || '0.00'}</td>
                    </tr>
                    <tr>
                        <td><strong>Total Cost:</strong></td>
                        <td><strong>₹${bom.total_cost || '0.00'}</strong></td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="mt-3">
            <h6>Components</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>UOM</th>
                            <th>Cost per Unit</th>
                            <th>Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bom.items ? bom.items.map(item => `
                            <tr>
                                <td>${item.item_code}</td>
                                <td>${item.item_name}</td>
                                <td>${item.quantity}</td>
                                <td>${item.uom}</td>
                                <td>₹${item.cost_per_unit || '0.00'}</td>
                                <td>₹${item.total_cost || '0.00'}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="6" class="text-center text-muted">No components found</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="/production/bom/${bom.bom_code}/edit" class="btn btn-primary btn-sm">
                <i class="fas fa-edit"></i> Edit BOM
            </a>
            <a href="/production/bom/${bom.bom_code}/view" class="btn btn-outline-info btn-sm">
                <i class="fas fa-eye"></i> View Details
            </a>
        </div>
    `;
    
    panel.style.display = 'block';
}

function showError(message) {
    const container = document.getElementById('bom-tree-container');
    container.innerHTML = `
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}
</script>
{% endblock %}