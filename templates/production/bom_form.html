{% extends "base.html" %}

{% block title %}
    {% if bom %}Edit BOM - {{ bom.bom_code }}{% else %}Create New BOM{% endif %}
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">
                            <i class="fas fa-sitemap text-primary me-2"></i>
                            {% if bom %}Edit BOM{% else %}Create New BOM{% endif %}
                        </h2>
                        <p class="text-muted mb-0">
                            {% if bom %}
                                Update BOM information and manage components
                            {% else %}
                                Define materials and processes for production
                            {% endif %}
                        </p>
                    </div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('main.dashboard') }}" class="text-decoration-none">
                                    <i class="fas fa-home"></i> Dashboard
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('production.production_dashboard') }}" class="text-decoration-none">Production</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('production.list_bom') }}" class="text-decoration-none">BOM Management</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                {% if bom %}Edit BOM{% else %}Create BOM{% endif %}
                            </li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check' }} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Main Content Card -->
        <div class="card shadow">
            <div class="card-body p-4">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <!-- BOM Information Section -->
                    <div class="mb-5">
                        <h5 class="card-title mb-4">BOM Information</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label text-muted">Product</label>
                                {{ form.product_id(class="form-select") }}
                                {% if form.product_id.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.product_id.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted">Output Quantity</label>
                                <div class="input-group">
                                    {{ form.output_quantity(class="form-control", step="0.001") }}
                                    {{ form.output_uom_id(class="form-select", style="max-width: 80px;") }}
                                </div>
                                {% if form.output_quantity.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.output_quantity.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted">Status</label>
                                <select class="form-select" name="status">
                                    <option value="active" {% if bom and bom.is_active %}selected{% endif %}>Active</option>
                                    <option value="draft" {% if bom and not bom.is_active %}selected{% endif %}>Draft</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <label class="form-label text-muted">BOM ID</label>
                                {{ form.bom_code(class="form-control", placeholder="BOM-001") }}
                                {% if form.bom_code.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.bom_code.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted">Revision</label>
                                {{ form.version(class="form-control", placeholder="1") }}
                            </div>
                        </div>
                    </div>

                    {% if bom %}
                    <!-- Raw Materials Section -->
                    <div class="mb-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Raw Materials</h5>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMaterialModal">
                                <i class="fas fa-plus me-1"></i> Add Item
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th>Required Qty</th>
                                        <th>UOM</th>
                                        <th>Unit Cost</th>
                                        <th>Total Cost</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in bom.items %}
                                    <tr>
                                        <td>{{ item.item.name }}</td>
                                        <td>{{ item.quantity_required }}</td>
                                        <td>{{ item.unit }}</td>
                                        <td>₹{{ "%.2f"|format(item.unit_cost or 0) }}</td>
                                        <td>₹{{ "%.2f"|format((item.quantity_required * item.unit_cost) if item.unit_cost else 0) }}</td>
                                        <td>
                                            <a href="{{ url_for('production.delete_bom_item', item_id=item.id) }}" 
                                               class="btn btn-outline-danger btn-sm"
                                               onclick="return confirm('Are you sure you want to remove this item?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if not bom.items %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-3">
                                            <i class="fas fa-box me-2"></i>No materials added yet. Click "Add Item" to get started.
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Processes Section -->
                    <div class="mb-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Processes</h5>
                            <a href="{{ url_for('production.add_bom_process', bom_id=bom.id) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-1"></i> Add Process
                            </a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Step</th>
                                        <th>Department</th>
                                        <th>Machine</th>
                                        <th>Output Product</th>
                                        <th>Duration</th>
                                        <th>Rate</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for process in bom.processes %}
                                    <tr>
                                        <td>{{ process.step_name }}</td>
                                        <td>{{ process.department.name if process.department else 'Job Work' }}</td>
                                        <td>{{ process.machine_name or '-' }}</td>
                                        <td>{{ process.output_item.name if process.output_item else '-' }}</td>
                                        <td>{{ (process.setup_time_minutes or 0) + (process.cycle_time_minutes or 0) }} min</td>
                                        <td>₹{{ "%.2f"|format(process.cost_per_unit or 0) }}</td>
                                        <td>
                                            <a href="{{ url_for('production.delete_bom_process', process_id=process.id) }}" 
                                               class="btn btn-outline-danger btn-sm"
                                               onclick="return confirm('Are you sure you want to remove this process?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if not bom.processes %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-3">
                                            <i class="fas fa-cogs me-2"></i>No processes defined yet. Click "Add Process" to get started.
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Settings Section -->
                    <div class="mb-5">
                        <h5 class="card-title mb-3">Settings</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    {{ form.is_phantom_bom(class="form-check-input") }}
                                    {{ form.is_phantom_bom.label(class="form-check-label") }}
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="allow_scrap" id="allow_scrap">
                                    <label class="form-check-label" for="allow_scrap">
                                        Allow Scrap Adjustment
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="fw-bold">Material Cost</div>
                                        <div class="h6">₹{{ "%.2f"|format(bom.material_cost or 0) if bom else "0.00" }}</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold">Labor Cost</div>
                                        <div class="h6">₹{{ "%.2f"|format(bom.labor_cost_per_unit or 0) if bom else "0.00" }}</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold">Overhead</div>
                                        <div class="h6">₹{{ "%.2f"|format(bom.overhead_cost_per_unit or 0) if bom else "0.00" }}</div>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <div class="text-center">
                                    <div class="fw-bold">Total Cost</div>
                                    <div class="h5 text-success">₹{{ "%.2f"|format(bom.total_cost or 0) if bom else "0.00" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attachments and Notes -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Attachments</h6>
                            <div class="border rounded p-4 text-center text-muted">
                                <i class="fas fa-upload fa-2x mb-2"></i>
                                <div>Upload</div>
                                <small>Drag files here or click to browse</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Notes</h6>
                            <textarea class="form-control" name="notes" rows="4" placeholder="Add notes about this BOM...">{{ bom.notes if bom else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12">
                            <div class="bg-light p-3 rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{{ url_for('production.list_bom') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancel
                                    </a>
                                    <div class="d-flex gap-3">
                                        {% if not bom %}
                                        <button type="submit" name="action" value="save_and_close" class="btn btn-success px-4">
                                            <i class="fas fa-check me-2"></i>Create BOM & Close
                                        </button>
                                        <button type="submit" name="action" value="save_and_continue" class="btn btn-primary px-4">
                                            <i class="fas fa-plus me-2"></i>Create BOM & Add Components
                                        </button>
                                        {% else %}
                                        <button type="submit" class="btn btn-success px-4">
                                            <i class="fas fa-save me-2"></i>Update BOM Information
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>

        <!-- Add Material Modal -->
        {% if bom %}
        <div class="modal fade" id="addMaterialModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Material/Component</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{{ url_for('production.add_bom_item', bom_id=bom.id) }}">
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Material/Component</label>
                                    <select name="item_id" class="form-select" required onchange="updateUnitCost()">
                                        <option value="">Choose Material/Component...</option>
                                        {% for material in materials %}
                                            <option value="{{ material.id }}" data-unit-price="{{ material.unit_price or 0 }}">
                                                {{ material.code }} - {{ material.name }} (₹{{ "%.2f"|format(material.unit_price or 0) }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" name="quantity_required" class="form-control" step="0.01" min="0" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Unit</label>
                                    <select name="unit" class="form-select" required>
                                        <option value="pcs">pcs</option>
                                        <option value="kg">kg</option>
                                        <option value="nos">nos</option>
                                        <option value="litre">litre</option>
                                        <option value="meter">meter</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Unit Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" name="unit_cost" id="unit_cost" class="form-control" step="0.01" min="0" value="0" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add to BOM</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <script>
        function updateUnitCost() {
            const select = document.querySelector('select[name="item_id"]');
            const unitCostInput = document.getElementById('unit_cost');
            
            if (select.selectedOptions.length > 0) {
                const selectedOption = select.selectedOptions[0];
                const unitPrice = selectedOption.getAttribute('data-unit-price');
                unitCostInput.value = unitPrice || '0.00';
            } else {
                unitCostInput.value = '0.00';
            }
        }
    </script>
{% endblock %}