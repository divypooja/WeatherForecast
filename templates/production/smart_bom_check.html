<!-- Smart BOM Material Availability Check Template -->
<div class="card mt-3">
    <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-clipboard-check"></i> Smart Material Requirements Check</h6>
    </div>
    <div class="card-body">
        <div id="materialRequirements">
            <!-- This will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
function checkSmartMaterialRequirements(bomId, productionQuantity) {
    if (!bomId || !productionQuantity) return;
    
    fetch('/production/check-smart-requirements', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            bom_id: bomId,
            production_quantity: productionQuantity
        })
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('materialRequirements');
        
        if (data.requirements && data.requirements.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr>';
            html += '<th>Material</th>';
            html += '<th>Required (BOM Unit)</th>';
            html += '<th>Available (Inventory)</th>';
            html += '<th>Conversion</th>';
            html += '<th>Status</th>';
            html += '</tr></thead><tbody>';
            
            let allAvailable = true;
            
            data.requirements.forEach(req => {
                const statusClass = req.is_sufficient ? 'success' : 'danger';
                const statusIcon = req.is_sufficient ? 'check-circle' : 'exclamation-triangle';
                const statusText = req.is_sufficient ? 'Available' : `Short by ${req.shortage_in_bom_unit.toFixed(2)} ${req.bom_unit}`;
                
                if (!req.is_sufficient) allAvailable = false;
                
                html += `<tr class="table-${statusClass === 'danger' ? 'warning' : ''}">`;
                html += `<td><strong>${req.material.name}</strong><br><small class="text-muted">${req.material.code}</small></td>`;
                html += `<td>${req.required_qty_bom_unit} ${req.bom_unit}</td>`;
                html += `<td>${req.available_stock.toFixed(2)} ${req.inventory_unit}</td>`;
                html += `<td><small class="text-info">${req.conversion_info}</small></td>`;
                html += `<td><span class="badge bg-${statusClass}"><i class="fas fa-${statusIcon}"></i> ${statusText}</span></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            // Add overall status
            if (allAvailable) {
                html = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> All materials are available for production!</div>' + html;
            } else {
                html = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Some materials are short. Please check inventory before proceeding.</div>' + html;
            }
            
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="alert alert-info">No material requirements found for this BOM.</div>';
        }
    })
    .catch(error => {
        console.error('Error checking requirements:', error);
        document.getElementById('materialRequirements').innerHTML = 
            '<div class="alert alert-danger">Error checking material requirements. Please try again.</div>';
    });
}

// Auto-check when production quantity or BOM changes
document.addEventListener('DOMContentLoaded', function() {
    const bomSelect = document.getElementById('bom_id');
    const qtyInput = document.getElementById('planned_quantity');
    
    if (bomSelect && qtyInput) {
        function triggerCheck() {
            checkSmartMaterialRequirements(bomSelect.value, qtyInput.value);
        }
        
        bomSelect.addEventListener('change', triggerCheck);
        qtyInput.addEventListener('input', debounce(triggerCheck, 500));
    }
});

// Debounce function to avoid too many API calls
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>