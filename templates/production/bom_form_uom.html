{% extends "base.html" %}

{% block title %}{{ title }} - AK Innovations{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('production.dashboard') }}">Production</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('production.list_bom') }}">Bill of Materials</a></li>
                    <li class="breadcrumb-item active">{{ title }}</li>
                </ol>
            </nav>
            <h2><i class="fas fa-sitemap"></i> {{ title }}</h2>
            <p class="text-muted">Configure materials and components with UOM conversions</p>
        </div>
    </div>

    <div class="row">
        <!-- BOM Information -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> BOM Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ form.product_id.label(class="form-label") }}
                            {{ form.product_id(class="form-select") }}
                            {% if form.product_id.errors %}
                                <div class="text-danger small">
                                    {% for error in form.product_id.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.version.label(class="form-label") }}
                                    {{ form.version(class="form-control") }}
                                    {% if form.version.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.version.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.production_unit_id.label(class="form-label") }}
                                    {{ form.production_unit_id(class="form-select") }}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> Unit for production quantity
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows="3") }}
                            <div class="form-text">Optional notes about this BOM</div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_active(class="form-check-input") }}
                                {{ form.is_active.label(class="form-check-label") }}
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            {{ form.submit(class="btn btn-primary") }}
                            <a href="{{ url_for('production.list_bom') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- UOM Configuration Info -->
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-header">
                    <h5><i class="fas fa-balance-scale"></i> UOM Integration</h5>
                </div>
                <div class="card-body">
                    <h6>How BOM-UOM Integration Works:</h6>
                    <ul class="small">
                        <li><strong>Production Unit:</strong> Unit for the finished product quantity</li>
                        <li><strong>BOM Unit:</strong> Unit for individual material requirements</li>
                        <li><strong>Automatic Conversion:</strong> System converts between BOM units and inventory units</li>
                        <li><strong>Material Planning:</strong> Accurate material calculations for any production quantity</li>
                    </ul>
                    
                    <div class="alert alert-info small">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Example:</strong> A product sold in pieces might require materials measured in Kg. 
                        Configure the BOM to specify materials in Kg while production is planned in pieces.
                    </div>
                    
                    <div class="mt-3">
                        <h6>Available UOM Categories:</h6>
                        <div class="row">
                            <div class="col-6">
                                <small>
                                    <strong>Weight:</strong> Kg, g<br>
                                    <strong>Count:</strong> Pcs, Nos<br>
                                    <strong>Length:</strong> M, cm, mm
                                </small>
                            </div>
                            <div class="col-6">
                                <small>
                                    <strong>Volume:</strong> L, ml<br>
                                    <strong>Area:</strong> Sq M, Sq cm<br>
                                    <strong>Time:</strong> Hr, Min
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOM Items Section -->
    {% if bom or title == 'Add BOM' %}
    <div class="row mt-4">
        <div class="col-12">
            <!-- Add BOM Item Form -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-plus-circle"></i> Add Material/Component</h5>
                </div>
                <div class="card-body">
                    {% if bom %}
                    <form action="{{ url_for('production.add_bom_item', bom_id=bom.id) }}" method="POST">
                    {% else %}
                    <form id="add-material-form" onsubmit="addMaterialToList(event)">
                    {% endif %}
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Material/Component</label>
                                <select name="item_id" class="form-select" required onchange="updateItemInfo()">
                                    <option value="">Select Item</option>
                                    {% for material in materials %}
                                    <option value="{{ material.id }}" 
                                            data-unit="{{ material.unit_of_measure }}"
                                            data-price="{{ material.unit_price or 0 }}">
                                        {{ material.code }} - {{ material.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Quantity Required</label>
                                <input type="number" name="quantity_required" class="form-control" step="0.001" min="0" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">BOM Unit</label>
                                <select name="bom_unit_id" class="form-select">
                                    <option value="0">Use Inventory Unit</option>
                                    {% for unit in units %}
                                    <option value="{{ unit.id }}">{{ unit.name }} ({{ unit.symbol }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Unit Cost</label>
                                <input type="number" name="unit_cost" class="form-control" step="0.01" min="0" value="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Notes</label>
                                <input type="text" name="notes" class="form-control" placeholder="Optional">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                {% if bom %}
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-plus"></i>
                                </button>
                                {% else %}
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-plus"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- BOM Items List -->
            {% if bom_items %}
            <!-- For existing BOM (edit mode) -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> BOM Components ({{ bom_items|length }} items)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Name</th>
                                    <th>Required Qty</th>
                                    <th>BOM Unit</th>
                                    <th>Inventory Unit</th>
                                    <th>Unit Cost</th>
                                    <th>Total Cost</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_cost = 0 %}
                                {% for bom_item in bom_items %}
                                {% set item_total = bom_item.quantity_required * (bom_item.unit_cost or 0) %}
                                {% set total_cost = total_cost + item_total %}
                                <tr>
                                    <td>
                                        <strong>{{ bom_item.item.code }}</strong>
                                    </td>
                                    <td>{{ bom_item.item.name }}</td>
                                    <td>
                                        <span class="badge bg-primary">
                                            {{ bom_item.quantity_required }} {{ bom_item.get_unit_display() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if bom_item.bom_unit %}
                                            <span class="badge bg-info">{{ bom_item.bom_unit.symbol }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ bom_item.item.unit_of_measure }}</span>
                                    </td>
                                    <td>₹{{ "%.2f"|format(bom_item.unit_cost or 0) }}</td>
                                    <td>₹{{ "%.2f"|format(item_total) }}</td>
                                    <td>
                                        {% if bom_item.notes %}
                                            <small class="text-muted">{{ bom_item.notes }}</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('production.delete_bom_item', id=bom_item.id) }}" 
                                           class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('Remove this item from BOM?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-dark">
                                    <th colspan="6">Total BOM Cost</th>
                                    <th>₹{{ "%.2f"|format(total_cost) }}</th>
                                    <th colspan="2"></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card mt-3">
                <div class="card-body text-center py-5">
                    <i class="fas fa-components fa-3x text-muted mb-3"></i>
                    <h5>No Components Added</h5>
                    <p class="text-muted">Start by adding materials and components to this BOM.</p>
                </div>
            </div>
            {% endif %}
            {% else %}
            <!-- For new BOM (add mode) - Temporary materials list -->
            <div class="card mt-3" id="temp-materials-card" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Materials to Add <span id="materials-count" class="badge bg-primary">0</span></h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="temp-materials-table">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Name</th>
                                    <th>Required Qty</th>
                                    <th>BOM Unit</th>
                                    <th>Unit Cost</th>
                                    <th>Total Cost</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="temp-materials-tbody">
                                <!-- Materials will be added here dynamically -->
                            </tbody>
                            <tfoot>
                                <tr class="table-dark">
                                    <th colspan="4">Total BOM Cost</th>
                                    <th id="total-cost">₹0.00</th>
                                    <th colspan="3"></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> These materials will be added to the BOM when you click "Save BOM".
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
let tempMaterials = [];
let materialIdCounter = 1;

function updateItemInfo() {
    const itemSelect = document.querySelector('select[name="item_id"]');
    const selectedOption = itemSelect.options[itemSelect.selectedIndex];
    
    if (selectedOption.value) {
        const unitCostField = document.querySelector('input[name="unit_cost"]');
        const price = selectedOption.getAttribute('data-price');
        if (price && price !== '0') {
            unitCostField.value = price;
        }
    }
}

function addMaterialToList(event) {
    event.preventDefault();
    
    const form = document.getElementById('add-material-form');
    const formData = new FormData(form);
    
    const itemSelect = form.querySelector('select[name="item_id"]');
    const selectedOption = itemSelect.options[itemSelect.selectedIndex];
    
    if (!selectedOption.value) {
        alert('Please select a material/component');
        return;
    }
    
    const unitSelect = form.querySelector('select[name="bom_unit_id"]');
    const unitOption = unitSelect.options[unitSelect.selectedIndex];
    
    const material = {
        id: materialIdCounter++,
        item_id: selectedOption.value,
        item_code: selectedOption.text.split(' - ')[0],
        item_name: selectedOption.text.split(' - ')[1],
        quantity_required: parseFloat(formData.get('quantity_required')),
        bom_unit_id: formData.get('bom_unit_id'),
        bom_unit_name: unitOption.text,
        unit_cost: parseFloat(formData.get('unit_cost') || 0),
        notes: formData.get('notes') || ''
    };
    
    // Check if item already exists
    if (tempMaterials.find(m => m.item_id === material.item_id)) {
        alert('This material is already added to the BOM');
        return;
    }
    
    tempMaterials.push(material);
    updateTempMaterialsDisplay();
    form.reset();
}

function removeTempMaterial(id) {
    tempMaterials = tempMaterials.filter(m => m.id !== id);
    updateTempMaterialsDisplay();
}

function updateTempMaterialsDisplay() {
    const card = document.getElementById('temp-materials-card');
    const tbody = document.getElementById('temp-materials-tbody');
    const countBadge = document.getElementById('materials-count');
    const totalCostElement = document.getElementById('total-cost');
    
    if (tempMaterials.length === 0) {
        card.style.display = 'none';
        return;
    }
    
    card.style.display = 'block';
    countBadge.textContent = tempMaterials.length;
    
    let totalCost = 0;
    let html = '';
    
    tempMaterials.forEach(material => {
        const itemTotal = material.quantity_required * material.unit_cost;
        totalCost += itemTotal;
        
        html += `
            <tr>
                <td><strong>${material.item_code}</strong></td>
                <td>${material.item_name}</td>
                <td><span class="badge bg-primary">${material.quantity_required}</span></td>
                <td><span class="badge bg-info">${material.bom_unit_name}</span></td>
                <td>₹${material.unit_cost.toFixed(2)}</td>
                <td>₹${itemTotal.toFixed(2)}</td>
                <td><small class="text-muted">${material.notes || '-'}</small></td>
                <td>
                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            onclick="removeTempMaterial(${material.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    totalCostElement.textContent = `₹${totalCost.toFixed(2)}`;
}

// Update the main BOM form submission to include temp materials
document.addEventListener('DOMContentLoaded', function() {
    const bomForm = document.querySelector('form[method="POST"]:not(#add-material-form)');
    if (bomForm) {
        bomForm.addEventListener('submit', function(e) {
            if (tempMaterials.length > 0) {
                // Add hidden fields for temp materials
                tempMaterials.forEach((material, index) => {
                    const hiddenFields = [
                        { name: `materials[${index}][item_id]`, value: material.item_id },
                        { name: `materials[${index}][quantity_required]`, value: material.quantity_required },
                        { name: `materials[${index}][bom_unit_id]`, value: material.bom_unit_id },
                        { name: `materials[${index}][unit_cost]`, value: material.unit_cost },
                        { name: `materials[${index}][notes]`, value: material.notes }
                    ];
                    
                    hiddenFields.forEach(field => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = field.name;
                        input.value = field.value;
                        bomForm.appendChild(input);
                    });
                });
            }
        });
    }
});
</script>
{% endblock %}