{% extends "base.html" %}

{% block title %}{{ title }} - Factory Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-tools"></i> {{ title }}</h1>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('jobwork.list_job_works') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Job Works
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Job Work Details</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.job_number.label(class="form-label") }}
                                {{ form.job_number(class="form-control") }}
                                {% if form.job_number.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.job_number.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.customer_name.label(class="form-label") }}
                                {{ form.customer_name(class="form-select") }}
                                {% if form.customer_name.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.customer_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.item_id.label(class="form-label") }}
                                {{ form.item_id(class="form-select", id="item_id") }}
                                {% if form.item_id.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.item_id.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.process_type.label(class="form-label") }}
                                {{ form.process_type(class="form-select", id="process_type") }}
                                <small class="text-muted">Select the type of process for this job work</small>
                                {% if form.process_type.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.process_type.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.quantity_sent.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.quantity_sent(class="form-control", step="0.01", id="quantity_sent") }}
                                    <span class="input-group-text" id="quantity-unit">units</span>
                                    <button type="button" class="btn btn-outline-info" id="check-stock-btn" onclick="checkInventoryStock()">
                                        <i class="fas fa-search"></i> Check Stock
                                    </button>
                                </div>
                                <div id="stock-info" class="mt-2"></div>
                                <!-- Weight conversion display -->
                                <div id="weight-conversion" class="mt-2" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="fas fa-weight"></i> <strong>Weight Calculation:</strong><br>
                                        <span id="weight-calculation-text"></span>
                                    </div>
                                </div>
                                <small class="text-muted">Available stock will be checked before sending</small>
                                {% if form.quantity_sent.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.quantity_sent.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.rate_per_unit.label(class="form-label") }}
                                {{ form.rate_per_unit(class="form-control", step="0.01", id="rate_per_unit") }}
                                <small class="text-muted">Enter the rate per unit for this job work</small>
                                {% if form.rate_per_unit.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.rate_per_unit.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.expected_finished_material.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.expected_finished_material(class="form-control", id="expected_finished_material", step="0.01") }}
                                    <span class="input-group-text" id="finished-material-unit">units</span>
                                </div>
                                <small class="text-muted">Expected finished material quantity (optional)</small>
                                {% if form.expected_finished_material.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.expected_finished_material.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.expected_scrap.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.expected_scrap(class="form-control", id="expected_scrap", step="0.01") }}
                                    <span class="input-group-text" id="scrap-unit">units</span>
                                </div>
                                <small class="text-muted">Expected scrap quantity (optional)</small>
                                {% if form.expected_scrap.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.expected_scrap.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.sent_date.label(class="form-label") }}
                                {{ form.sent_date(class="form-control") }}
                                {% if form.sent_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.sent_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.expected_return.label(class="form-label") }}
                                {{ form.expected_return(class="form-control") }}
                                {% if form.expected_return.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.expected_return.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        
                        <div class="mb-3">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows="3") }}
                            <div class="form-text">Add details about materials sent, work required, etc.</div>
                            {% if form.notes.errors %}
                                <div class="text-danger small">
                                    {% for error in form.notes.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('jobwork.list_job_works') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-info me-2" onclick="previewJobWork()">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {{ 'Update' if job else 'Save' }} Job Work
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Document Management Section -->
            {% if job %}
            <div class="col-md-4">
                {% set documents = get_documents_for_transaction('job_work', job.id) %}
                {% set transaction_type = 'job_work' %}
                {% set transaction_id = job.id %}
                {% include 'documents/_document_card.html' %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye"></i> Job Work Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="document.querySelector('form').submit()">
                    <i class="fas fa-save"></i> Save Job Work
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Function to check inventory stock
function checkInventoryStock() {
    const itemSelect = document.getElementById('item_id');
    const quantityInput = document.getElementById('quantity_sent');
    const stockInfo = document.getElementById('stock-info');
    
    if (!itemSelect.value) {
        stockInfo.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Please select an item first</div>';
        return;
    }
    
    const quantity = parseFloat(quantityInput.value) || 0;
    
    // Fetch item stock information
    fetch(`/inventory/api/item-stock/${itemSelect.value}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const availableStock = data.current_stock || 0;
                const unit = data.unit_of_measure || 'units';
                
                let stockClass = 'alert-success';
                let stockMessage = `Available Stock: ${availableStock} ${unit}`;
                let stockIcon = 'fa-check-circle';
                
                if (quantity > availableStock) {
                    stockClass = 'alert-danger';
                    stockMessage = `Insufficient Stock! Available: ${availableStock} ${unit}, Required: ${quantity} ${unit}`;
                    stockIcon = 'fa-exclamation-triangle';
                } else if (availableStock < 10) { // Low stock warning
                    stockClass = 'alert-warning';
                    stockMessage = `Low Stock Warning: ${availableStock} ${unit} available`;
                    stockIcon = 'fa-exclamation-circle';
                }
                
                stockInfo.innerHTML = `<div class="alert ${stockClass}"><i class="fas ${stockIcon}"></i> ${stockMessage}</div>`;
            } else {
                stockInfo.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> Error checking stock</div>';
            }
        })
        .catch(error => {
            stockInfo.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> Error checking stock</div>';
        });
}

// Function to preview job work with detailed breakdown like BOM
function previewJobWork() {
    console.log('Preview function called'); // Debug log
    
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    // Get selected item name and details
    const itemSelect = document.getElementById('item_id');
    const selectedItemText = itemSelect && itemSelect.selectedIndex > 0 ? itemSelect.options[itemSelect.selectedIndex].text : 'Not selected';
    const itemId = itemSelect ? itemSelect.value : '';
    
    // Get selected customer name
    const customerSelect = document.querySelector('select[name="customer_name"]');
    const selectedCustomerText = customerSelect && customerSelect.selectedIndex > 0 ? customerSelect.options[customerSelect.selectedIndex].text : 'Not selected';
    
    const processSelect = document.getElementById('process_type');
    const selectedProcessText = processSelect && processSelect.selectedIndex > 0 ? processSelect.options[processSelect.selectedIndex].text : 'Not selected';
    
    const previewData = {
        job_number: formData.get('job_number'),
        customer_name: selectedCustomerText,
        item_name: selectedItemText,
        process: selectedProcessText,
        quantity_sent: parseFloat(formData.get('quantity_sent')) || 0,
        expected_finished_material: parseFloat(formData.get('expected_finished_material')) || 0,
        expected_scrap: parseFloat(formData.get('expected_scrap')) || 0,
        rate_per_unit: parseFloat(formData.get('rate_per_unit')) || 0,
        sent_date: formData.get('sent_date'),
        expected_return: formData.get('expected_return'),
        notes: formData.get('notes')
    };
    
    // Calculate values
    const totalValue = previewData.quantity_sent * previewData.rate_per_unit;
    
    // Get item stock information for detailed preview
    let stockInfo = '';
    if (itemId) {
        fetch(`/inventory/api/item-stock/${itemId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const availableStock = data.current_stock || 0;
                    const afterSending = availableStock - previewData.quantity_sent;
                    const stockStatus = previewData.quantity_sent > availableStock ? 'Insufficient Stock' : 'Sufficient Stock';
                    const stockClass = previewData.quantity_sent > availableStock ? 'bg-danger text-white' : 'bg-success text-white';
                    
                    stockInfo = `
                        <div class="alert alert-info">
                            <strong>Stock Impact Analysis:</strong><br>
                            Current Stock: ${availableStock} ${data.unit_of_measure || 'units'}<br>
                            Quantity to Send: ${previewData.quantity_sent} ${data.unit_of_measure || 'units'}<br>
                            Remaining After Send: <span class="${previewData.quantity_sent > availableStock ? 'text-danger' : 'text-success'}">${afterSending} ${data.unit_of_measure || 'units'}</span><br>
                            Status: <span class="${previewData.quantity_sent > availableStock ? 'text-danger' : 'text-success'}">${stockStatus}</span>
                        </div>
                    `;
                    
                    document.getElementById('stock-analysis').innerHTML = stockInfo;
                }
            })
            .catch(error => {
                console.error('Error fetching stock info:', error);
            });
    }
    
    const previewContent = `
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> <strong>Review your Job Work configuration before saving.</strong>
</div>

<div class="card mb-3">
    <div class="card-header">
        <h6><i class="fas fa-cog"></i> Job Work Configuration</h6>
    </div>
    <div class="card-body">
        <table class="table table-borderless">
            <tr>
                <td><strong>Job Number:</strong></td>
                <td>${previewData.job_number || 'Auto-generated'}</td>
            </tr>
            <tr>
                <td><strong>Customer:</strong></td>
                <td>${previewData.customer_name || 'Not selected'}</td>
            </tr>
            <tr>
                <td><strong>Item:</strong></td>
                <td>${previewData.item_name || 'Not selected'}</td>
            </tr>
            <tr>
                <td><strong>Process:</strong></td>
                <td><span class="badge bg-info">${previewData.process || 'Not selected'}</span></td>
            </tr>
            <tr>
                <td><strong>Quantity Sent:</strong></td>
                <td>${previewData.quantity_sent}</td>
            </tr>
            <tr>
                <td><strong>Expected Finished Material:</strong></td>
                <td>${previewData.expected_finished_material || '0'}</td>
            </tr>
            <tr>
                <td><strong>Expected Scrap:</strong></td>
                <td>${previewData.expected_scrap || '0'}</td>
            </tr>
            <tr>
                <td><strong>Rate per Unit:</strong></td>
                <td>₹${previewData.rate_per_unit.toFixed(2)}</td>
            </tr>
            <tr>
                <td><strong>Sent Date:</strong></td>
                <td>${previewData.sent_date || 'Not set'}</td>
            </tr>
            <tr>
                <td><strong>Expected Return:</strong></td>
                <td>${previewData.expected_return || 'Not set'}</td>
            </tr>
        </table>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <h6><i class="fas fa-boxes"></i> Inventory Impact</h6>
    </div>
    <div class="card-body">
        <div id="stock-analysis">
            <div class="text-muted">
                <i class="fas fa-spinner fa-spin"></i> Checking inventory impact...
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <h6><i class="fas fa-calculator"></i> Value Breakdown</h6>
    </div>
    <div class="card-body">
        <table class="table table-borderless">
            <tr>
                <td><strong>Quantity:</strong></td>
                <td class="text-end">${previewData.quantity_sent}</td>
            </tr>
            <tr>
                <td><strong>Rate per Unit:</strong></td>
                <td class="text-end">₹${previewData.rate_per_unit.toFixed(2)}</td>
            </tr>
            <tr class="table-dark">
                <td><strong>Total Value:</strong></td>
                <td class="text-end"><strong>₹${totalValue.toFixed(2)}</strong></td>
            </tr>
        </table>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h6><i class="fas fa-sticky-note"></i> Notes</h6>
    </div>
    <div class="card-body">
        <div class="bg-light p-3 rounded" style="min-height: 60px;">
            ${previewData.notes || '<em class="text-muted">No notes added</em>'}
        </div>
    </div>
</div>
`;
    
    console.log('Setting preview content:', previewContent); // Debug log
    
    const previewContentDiv = document.getElementById('preview-content');
    if (previewContentDiv) {
        previewContentDiv.innerHTML = previewContent;
        console.log('Content set successfully'); // Debug log
    } else {
        console.error('preview-content div not found'); // Debug log
    }
    
    const modalElement = document.getElementById('previewModal');
    if (modalElement) {
        const previewModal = new bootstrap.Modal(modalElement);
        previewModal.show();
        console.log('Modal shown'); // Debug log
    } else {
        console.error('previewModal not found'); // Debug log
    }
}

// Auto-check stock when item or quantity changes
document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.getElementById('item_id');
    const quantityInput = document.getElementById('quantity_sent');
    
    if (itemSelect && quantityInput) {
        itemSelect.addEventListener('change', function() {
            checkInventoryStock();
            updateUnitLabels();
        });
        quantityInput.addEventListener('input', function() {
            if (itemSelect.value) {
                checkInventoryStock();
                updateWeightConversion();
            }
        });
    }
});

// Function to update unit labels based on selected item
function updateUnitLabels() {
    const itemId = document.getElementById('item_id').value;
    if (itemId && itemId !== '0') {
        fetch(`/inventory/api/item-stock/${itemId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const unit = data.unit_of_measure || 'units';
                    const unitWeight = data.unit_weight || 0;
                    
                    // Update all unit labels in the form
                    document.getElementById('quantity-unit').textContent = unit;
                    document.getElementById('finished-material-unit').textContent = unit;
                    document.getElementById('scrap-unit').textContent = unit;
                    
                    // Store unit weight for calculations
                    window.currentItemUnitWeight = unitWeight;
                    window.currentItemUnit = unit;
                    
                    // Update weight conversion display
                    updateWeightConversion();
                }
            })
            .catch(error => {
                console.error('Error fetching item details:', error);
            });
    } else {
        // Reset to default units when no item selected
        document.getElementById('quantity-unit').textContent = 'units';
        document.getElementById('finished-material-unit').textContent = 'units';
        document.getElementById('scrap-unit').textContent = 'units';
        document.getElementById('weight-conversion').style.display = 'none';
        window.currentItemUnitWeight = 0;
        window.currentItemUnit = 'units';
    }
}

// Function to update weight conversion display
function updateWeightConversion() {
    const quantityInput = document.getElementById('quantity_sent');
    const weightConversionDiv = document.getElementById('weight-conversion');
    const weightCalculationText = document.getElementById('weight-calculation-text');
    
    if (!quantityInput || !weightConversionDiv || !weightCalculationText) return;
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const unitWeight = window.currentItemUnitWeight || 0;
    const unit = window.currentItemUnit || 'units';
    
    // Show weight conversion if unit is not already weight-based and unit weight is available
    const isWeightUnit = ['kg', 'g', 'gm', 'gram', 'kilogram', 'ton', 'tonne'].includes(unit.toLowerCase());
    
    if (!isWeightUnit && unitWeight > 0 && quantity > 0) {
        const totalWeight = quantity * unitWeight;
        const weightUnit = totalWeight >= 1 ? 'kg' : 'g';
        const displayWeight = totalWeight >= 1 ? totalWeight.toFixed(3) : (totalWeight * 1000).toFixed(1);
        
        weightCalculationText.innerHTML = `
            ${quantity} ${unit} × ${unitWeight} kg/unit = <strong>${displayWeight} ${weightUnit}</strong>
        `;
        weightConversionDiv.style.display = 'block';
    } else {
        weightConversionDiv.style.display = 'none';
    }
}
</script>
{% endblock %}