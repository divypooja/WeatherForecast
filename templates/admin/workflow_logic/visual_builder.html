{% extends "base.html" %}

{% block title %}Visual Workflow Builder - {{ template.name }} - Factory Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-project-diagram"></i> Visual Workflow Builder - {{ template.name }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('dynamic_forms.dashboard') }}">Dynamic Forms</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('workflow_logic.dashboard', template_id=template.id) }}">{{ template.name }} Logic</a></li>
                    <li class="breadcrumb-item active">Visual Builder</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Workflow Canvas -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-sitemap"></i> Workflow Canvas</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="addConditionBtn">
                            <i class="fas fa-plus"></i> Add Condition
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" id="saveWorkflowBtn">
                            <i class="fas fa-save"></i> Save Workflow
                        </button>
                    </div>
                </div>
                <div class="card-body" style="min-height: 500px;">
                    <div id="workflowCanvas" class="position-relative w-100 h-100">
                        <!-- Workflow nodes will be dynamically created here -->
                        <div class="text-center mt-5 pt-5" id="emptyState">
                            <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                            <h4>Visual Workflow Designer</h4>
                            <p class="text-muted">Click "Add Condition" to start building your workflow logic</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toolbox -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-toolbox"></i> Toolbox</h5>
                </div>
                <div class="card-body">
                    <!-- Available Fields -->
                    <h6>Available Fields</h6>
                    <div class="list-group mb-3" id="fieldsList">
                        {% for field in template.active_fields %}
                        <div class="list-group-item list-group-item-action draggable-field" 
                             data-field-id="{{ field.id }}" 
                             data-field-name="{{ field.field_name }}"
                             data-field-label="{{ field.label }}"
                             data-field-type="{{ field.field_type }}">
                            <i class="fas fa-grip-vertical me-2"></i>
                            <strong>{{ field.label }}</strong>
                            <br><small class="text-muted">{{ field.field_type }}</small>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Logic Operators -->
                    <h6>Logic Operators</h6>
                    <div class="mb-3">
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-sm btn-outline-primary operator-btn" data-operator="equals">
                                <i class="fas fa-equals"></i> Equals
                            </button>
                            <button class="btn btn-sm btn-outline-primary operator-btn" data-operator="contains">
                                <i class="fas fa-search"></i> Contains
                            </button>
                            <button class="btn btn-sm btn-outline-primary operator-btn" data-operator="greater_than">
                                <i class="fas fa-greater-than"></i> Greater Than
                            </button>
                            <button class="btn btn-sm btn-outline-primary operator-btn" data-operator="empty">
                                <i class="fas fa-ban"></i> Is Empty
                            </button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <h6>Actions</h6>
                    <div class="mb-3">
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-sm btn-outline-success action-btn" data-action="show_field">
                                <i class="fas fa-eye"></i> Show Field
                            </button>
                            <button class="btn btn-sm btn-outline-danger action-btn" data-action="hide_field">
                                <i class="fas fa-eye-slash"></i> Hide Field
                            </button>
                            <button class="btn btn-sm btn-outline-warning action-btn" data-action="require_field">
                                <i class="fas fa-asterisk"></i> Make Required
                            </button>
                            <button class="btn btn-sm btn-outline-info action-btn" data-action="set_value">
                                <i class="fas fa-edit"></i> Set Value
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-sliders-h"></i> Properties</h5>
                </div>
                <div class="card-body">
                    <div id="propertiesPanel">
                        <p class="text-muted">Select a workflow element to edit properties</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Condition Modal -->
<div class="modal fade" id="conditionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Workflow Condition</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="conditionForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Source Field</label>
                            <select class="form-select" id="sourceField" required>
                                <option value="">-- Select Field --</option>
                                {% for field in template.active_fields %}
                                <option value="{{ field.id }}">{{ field.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Operator</label>
                            <select class="form-select" id="operator" required>
                                <option value="equals">Equals</option>
                                <option value="not_equals">Not Equals</option>
                                <option value="contains">Contains</option>
                                <option value="greater_than">Greater Than</option>
                                <option value="less_than">Less Than</option>
                                <option value="empty">Is Empty</option>
                                <option value="not_empty">Is Not Empty</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Condition Value</label>
                            <input type="text" class="form-control" id="conditionValue" placeholder="Enter value to compare">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Target Field</label>
                            <select class="form-select" id="targetField" required>
                                <option value="">-- Select Field --</option>
                                {% for field in template.active_fields %}
                                <option value="{{ field.id }}">{{ field.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Action</label>
                            <select class="form-select" id="action" required>
                                <option value="show_field">Show Field</option>
                                <option value="hide_field">Hide Field</option>
                                <option value="require_field">Make Required</option>
                                <option value="optional_field">Make Optional</option>
                                <option value="set_value">Set Value</option>
                                <option value="clear_value">Clear Value</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Action Value (if needed)</label>
                            <input type="text" class="form-control" id="actionValue" placeholder="Value to set">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveConditionBtn">Save Condition</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const templateId = {{ template.id }};
    let conditions = {{ conditions | tojson }};
    let conditionCounter = 0;
    
    // Initialize visual builder
    function initializeVisualBuilder() {
        renderWorkflowNodes();
    }
    
    // Render workflow nodes on canvas
    function renderWorkflowNodes() {
        const canvas = $('#workflowCanvas');
        canvas.empty();
        
        if (conditions.length === 0) {
            canvas.html(`
                <div class="text-center mt-5 pt-5" id="emptyState">
                    <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                    <h4>Visual Workflow Designer</h4>
                    <p class="text-muted">Click "Add Condition" to start building your workflow logic</p>
                </div>
            `);
            return;
        }
        
        // Create workflow nodes
        conditions.forEach((condition, index) => {
            const node = createWorkflowNode(condition, index);
            canvas.append(node);
        });
        
        // Draw connections between nodes
        drawConnections();
    }
    
    // Create a workflow node
    function createWorkflowNode(condition, index) {
        const nodeId = `node_${index}`;
        const x = 50 + (index % 3) * 250;
        const y = 50 + Math.floor(index / 3) * 150;
        
        return $(`
            <div class="workflow-node" id="${nodeId}" style="position: absolute; left: ${x}px; top: ${y}px;">
                <div class="card border-primary" style="width: 200px;">
                    <div class="card-header bg-primary text-white p-2">
                        <small>Condition ${index + 1}</small>
                        <button class="btn btn-sm btn-outline-light float-end" onclick="editCondition(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="card-body p-2">
                        <small>
                            <strong>IF</strong> ${condition.source_field_name}<br>
                            ${condition.operator.replace('_', ' ')}<br>
                            ${condition.condition_value || ''}<br>
                            <strong>THEN</strong> ${condition.action.replace('_', ' ')}<br>
                            ${condition.target_field_name}
                        </small>
                    </div>
                </div>
            </div>
        `);
    }
    
    // Draw connections between nodes
    function drawConnections() {
        // Add SVG for drawing lines
        const canvas = $('#workflowCanvas');
        if (!canvas.find('svg').length) {
            canvas.append('<svg class="workflow-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></svg>');
        }
        
        const svg = canvas.find('svg');
        svg.empty();
        
        // Draw lines between connected nodes
        for (let i = 0; i < conditions.length - 1; i++) {
            const startNode = $(`#node_${i}`);
            const endNode = $(`#node_${i + 1}`);
            
            if (startNode.length && endNode.length) {
                const startX = parseInt(startNode.css('left')) + 100;
                const startY = parseInt(startNode.css('top')) + 50;
                const endX = parseInt(endNode.css('left')) + 100;
                const endY = parseInt(endNode.css('top')) + 50;
                
                svg.append(`<line x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" stroke="#007bff" stroke-width="2" marker-end="url(#arrowhead)"/>`);
            }
        }
        
        // Add arrow marker
        svg.prepend(`
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#007bff"/>
                </marker>
            </defs>
        `);
    }
    
    // Add condition button handler
    $('#addConditionBtn').on('click', function() {
        $('#conditionModal').modal('show');
    });
    
    // Save condition handler
    $('#saveConditionBtn').on('click', function() {
        const formData = {
            source_field_id: $('#sourceField').val(),
            operator: $('#operator').val(),
            condition_value: $('#conditionValue').val(),
            target_field_id: $('#targetField').val(),
            action: $('#action').val(),
            action_value: $('#actionValue').val(),
            condition_type: 'if',
            condition_order: conditions.length + 1
        };
        
        // Validate form
        if (!formData.source_field_id || !formData.target_field_id || !formData.operator || !formData.action) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Add to conditions array with field names for display
        const sourceFieldName = $('#sourceField option:selected').text();
        const targetFieldName = $('#targetField option:selected').text();
        
        conditions.push({
            ...formData,
            source_field_name: sourceFieldName,
            target_field_name: targetFieldName
        });
        
        // Re-render nodes
        renderWorkflowNodes();
        
        // Close modal and reset form
        $('#conditionModal').modal('hide');
        $('#conditionForm')[0].reset();
    });
    
    // Operator change handler
    $('#operator').on('change', function() {
        const operator = $(this).val();
        const conditionValueGroup = $('#conditionValue').closest('.col-md-6');
        
        if (['empty', 'not_empty'].includes(operator)) {
            conditionValueGroup.hide();
            $('#conditionValue').val('');
        } else {
            conditionValueGroup.show();
        }
    });
    
    // Action change handler
    $('#action').on('change', function() {
        const action = $(this).val();
        const actionValueGroup = $('#actionValue').closest('.col-md-6');
        
        if (action === 'set_value') {
            actionValueGroup.show();
        } else {
            actionValueGroup.hide();
            $('#actionValue').val('');
        }
    });
    
    // Save workflow handler
    $('#saveWorkflowBtn').on('click', function() {
        // Here you would save the workflow to the server
        alert('Workflow saved successfully!');
    });
    
    // Make nodes draggable
    $(document).on('mousedown', '.workflow-node', function(e) {
        const node = $(this);
        const startX = e.pageX - node.offset().left;
        const startY = e.pageY - node.offset().top;
        
        $(document).on('mousemove.drag', function(e) {
            node.css({
                left: e.pageX - startX,
                top: e.pageY - startY
            });
            drawConnections();
        });
        
        $(document).on('mouseup.drag', function() {
            $(document).off('.drag');
        });
    });
    
    // Initialize
    initializeVisualBuilder();
});

// Global function for editing conditions
function editCondition(index) {
    // Open condition modal with existing data
    const condition = {{ conditions | tojson }}[index];
    if (condition) {
        $('#sourceField').val(condition.source_field_id);
        $('#operator').val(condition.operator);
        $('#conditionValue').val(condition.condition_value);
        $('#targetField').val(condition.target_field_id);
        $('#action').val(condition.action);
        $('#actionValue').val(condition.action_value);
        $('#conditionModal').modal('show');
    }
}
</script>

<style>
.workflow-node {
    cursor: move;
    user-select: none;
}

.workflow-node:hover {
    transform: scale(1.02);
    transition: transform 0.2s;
}

.workflow-connections {
    z-index: 1;
}

.workflow-node {
    z-index: 2;
}

.draggable-field {
    cursor: grab;
}

.draggable-field:active {
    cursor: grabbing;
}

.operator-btn, .action-btn {
    margin-bottom: 5px;
    text-align: left;
}
</style>
{% endblock %}