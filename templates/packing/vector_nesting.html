{% extends "base.html" %}

{% block title %}Vector Nesting Optimization{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-puzzle-piece text-primary"></i> Vector Nesting Optimization</h2>
                    <p class="text-muted">Advanced irregular shape nesting using SVGNest algorithm</p>
                </div>
                <div>
                    <button class="btn btn-info" id="loadDemoBtn">
                        <i class="fas fa-play"></i> Load Demo Shapes
                    </button>
                    <button class="btn btn-success" id="startOptimizationBtn" disabled>
                        <i class="fas fa-cogs"></i> Start Optimization
                    </button>
                </div>
            </div>

            <!-- Algorithm Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-sliders-h"></i> SVGNest Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Space Between Parts (mm)</label>
                            <input type="number" class="form-control" id="spaceBetweenParts" value="2" min="0" step="0.1">
                            <small class="text-muted">Minimum gap for cutting kerf</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Part Rotations</label>
                            <select class="form-select" id="partRotations">
                                <option value="4">4 (90° increments)</option>
                                <option value="8">8 (45° increments)</option>
                                <option value="16">16 (22.5° increments)</option>
                                <option value="0">No rotation</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Population Size</label>
                            <input type="number" class="form-control" id="populationSize" value="10" min="5" max="50">
                            <small class="text-muted">Genetic algorithm population</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mutation Rate (%)</label>
                            <input type="number" class="form-control" id="mutationRate" value="10" min="1" max="50">
                            <small class="text-muted">Genetic algorithm mutation</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="partInPart">
                                <label class="form-check-label" for="partInPart">
                                    Part-in-Part Nesting
                                </label>
                                <small class="d-block text-muted">Place small parts inside holes</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exploreConcave">
                                <label class="form-check-label" for="exploreConcave">
                                    Explore Concave Areas
                                </label>
                                <small class="d-block text-muted">Better concave fitting</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Curve Tolerance</label>
                            <input type="number" class="form-control" id="curveTolerance" value="0.3" min="0.1" max="2" step="0.1">
                            <small class="text-muted">Curve approximation precision</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bin Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-square"></i> Container/Bin Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Bin Width (mm)</label>
                            <input type="number" class="form-control" id="binWidth" value="1200" min="100">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bin Height (mm)</label>
                            <input type="number" class="form-control" id="binHeight" value="800" min="100">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bin Shape</label>
                            <select class="form-select" id="binShape">
                                <option value="rectangle">Rectangle</option>
                                <option value="circle">Circle</option>
                                <option value="custom">Custom SVG</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parts Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-shapes"></i> Parts for Nesting</h5>
                </div>
                <div class="card-body">
                    <div id="partsContainer">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Click "Load Demo Shapes" to see example irregular shapes, or manually configure parts below.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optimization Results -->
            <div class="card mb-4" id="resultsCard" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Optimization Results</h5>
                </div>
                <div class="card-body">
                    <!-- Results will be populated here -->
                    <div id="optimizationResults"></div>
                </div>
            </div>

            <!-- Visualization -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-eye"></i> Nesting Visualization</h5>
                </div>
                <div class="card-body">
                    <div id="nestingVisualization">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
                            <p>Run optimization to see nesting visualization</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Optimizing Vector Nesting...</h5>
                <p class="text-muted">This may take up to 60 seconds for complex shapes</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadDemoBtn = document.getElementById('loadDemoBtn');
    const startOptimizationBtn = document.getElementById('startOptimizationBtn');
    const partsContainer = document.getElementById('partsContainer');
    const resultsCard = document.getElementById('resultsCard');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    let currentParts = [];
    let currentBin = null;

    // Load demo shapes
    loadDemoBtn.addEventListener('click', function() {
        fetch('/packing/api/demo-vector-shapes')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentBin = data.bin;
                    currentParts = data.parts;
                    displayParts(data.parts);
                    startOptimizationBtn.disabled = false;
                    
                    // Update bin fields
                    document.getElementById('binWidth').value = 1200;
                    document.getElementById('binHeight').value = 800;
                } else {
                    alert('Error loading demo shapes: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load demo shapes');
            });
    });

    // Start optimization
    startOptimizationBtn.addEventListener('click', function() {
        if (currentParts.length === 0) {
            alert('Please load parts first');
            return;
        }

        // Get configuration
        const config = {
            spaceBetweenParts: parseFloat(document.getElementById('spaceBetweenParts').value),
            partRotations: parseInt(document.getElementById('partRotations').value),
            populationSize: parseInt(document.getElementById('populationSize').value),
            mutationRate: parseInt(document.getElementById('mutationRate').value),
            partInPart: document.getElementById('partInPart').checked,
            exploreConcave: document.getElementById('exploreConcave').checked,
            curveTolerance: parseFloat(document.getElementById('curveTolerance').value)
        };

        // Create bin from current settings
        const binWidth = parseInt(document.getElementById('binWidth').value);
        const binHeight = parseInt(document.getElementById('binHeight').value);
        const bin = [
            {x: 0, y: 0},
            {x: binWidth, y: 0},
            {x: binWidth, y: binHeight},
            {x: 0, y: binHeight}
        ];

        // Show loading modal
        loadingModal.show();

        // Send optimization request
        fetch('/packing/api/optimize-vector-nesting', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                bin: bin,
                parts: currentParts,
                config: config
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingModal.hide();
            if (data.success) {
                displayResults(data);
                displayVisualization(data, bin);
                resultsCard.style.display = 'block';
            } else {
                alert('Optimization failed: ' + data.error);
            }
        })
        .catch(error => {
            loadingModal.hide();
            console.error('Error:', error);
            alert('Optimization request failed');
        });
    });

    function displayParts(parts) {
        partsContainer.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                Loaded ${parts.length} irregular shapes for nesting optimization
            </div>
            <div class="row">
                ${parts.map(part => `
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>${part.name}</h6>
                                <small class="text-muted">Qty: ${part.quantity}</small>
                                <div class="mt-2">
                                    <small class="badge bg-secondary">${part.polygon.length} vertices</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function displayResults(data) {
        const results = document.getElementById('optimizationResults');
        results.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>${data.efficiency_percentage}%</h4>
                            <small>Material Efficiency</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>${data.placed_parts.length}</h4>
                            <small>Parts Placed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h4>${data.unplaced_parts.length}</h4>
                            <small>Parts Unplaced</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>${data.optimization_time}s</h4>
                            <small>Optimization Time</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <h6>Optimization Details:</h6>
                <ul class="list-unstyled">
                    <li><strong>Algorithm:</strong> SVGNest (Genetic Algorithm + No-Fit Polygon)</li>
                    <li><strong>Bin Area:</strong> ${data.bin_area.toLocaleString()} mm²</li>
                    <li><strong>Used Area:</strong> ${data.total_area_used.toLocaleString()} mm²</li>
                    <li><strong>Waste Area:</strong> ${data.waste_area.toLocaleString()} mm²</li>
                    ${data.generation ? `<li><strong>Generation:</strong> ${data.generation}</li>` : ''}
                    ${data.fitness ? `<li><strong>Fitness Score:</strong> ${data.fitness.toFixed(3)}</li>` : ''}
                </ul>
            </div>
        `;
    }

    function displayVisualization(data, bin) {
        const visualization = document.getElementById('nestingVisualization');
        
        // Create SVG visualization
        const svgWidth = 800;
        const svgHeight = 600;
        const scale = Math.min(svgWidth / 1200, svgHeight / 800);
        
        let svg = `
            <svg width="${svgWidth}" height="${svgHeight}" style="border: 1px solid #ddd; background: white;">
                <!-- Bin outline -->
                <polygon points="${bin.map(p => `${p.x * scale},${p.y * scale}`).join(' ')}" 
                         fill="none" stroke="#333" stroke-width="2"/>
                
                <!-- Placed parts -->
                ${data.placed_parts.map((part, index) => {
                    const color = `hsl(${index * 360 / data.placed_parts.length}, 70%, 60%)`;
                    const points = part.polygon.map(p => 
                        `${(p.x + part.position.x) * scale},${(p.y + part.position.y) * scale}`
                    ).join(' ');
                    
                    return `
                        <polygon points="${points}" 
                                 fill="${color}" 
                                 stroke="#333" 
                                 stroke-width="1" 
                                 opacity="0.7">
                            <title>${part.part_id}</title>
                        </polygon>
                    `;
                }).join('')}
                
                <!-- Legend -->
                <text x="10" y="20" font-size="12" fill="#333">SVGNest Optimization Result</text>
                <text x="10" y="35" font-size="10" fill="#666">Efficiency: ${data.efficiency_percentage}%</text>
            </svg>
        `;
        
        visualization.innerHTML = svg;
    }
});
</script>
{% endblock %}