{% extends "base.html" %}

{% block title %}OCR Settings{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-cogs text-primary me-2"></i>OCR Settings</h2>
                    <p class="text-muted">Configure OCR processing preferences and behavior</p>
                </div>
                <a href="{{ url_for('ocr.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>

            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <!-- Engine Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-engine me-2"></i>OCR Engine Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_engine" class="form-label">Primary OCR Engine</label>
                                    <select class="form-select" id="default_engine" name="default_engine">
                                        <option value="tesseract" {{ 'selected' if settings.default_engine == 'tesseract' else '' }}>
                                            Tesseract (Fast, Good Accuracy)
                                        </option>
                                    </select>
                                    <div class="form-text">Primary engine used for OCR processing</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="confidence_threshold" class="form-label">Confidence Threshold (%)</label>
                                    <input type="number" class="form-control" id="confidence_threshold" 
                                           name="confidence_threshold" value="{{ settings.confidence_threshold }}" 
                                           min="0" max="100" step="0.1">
                                    <div class="form-text">Minimum confidence score to accept results</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="fallback_enabled" 
                                           name="fallback_enabled" {{ 'checked' if settings.fallback_enabled else '' }}>
                                    <label class="form-check-label" for="fallback_enabled">
                                        Enable Fallback Processing
                                    </label>
                                    <div class="form-text">Use backup processing if primary engine fails</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Options -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-image me-2"></i>Image Processing Options
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="image_preprocessing" 
                                           name="image_preprocessing" {{ 'checked' if settings.image_preprocessing else '' }}>
                                    <label class="form-check-label" for="image_preprocessing">
                                        <strong>Enable Image Preprocessing</strong>
                                    </label>
                                    <div class="form-text">
                                        Enhance image quality before OCR processing:<br>
                                        • Noise reduction and denoising<br>
                                        • Skew correction and straightening<br>
                                        • Contrast and brightness enhancement<br>
                                        • Binarization for better text detection
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="keep_processed_images" 
                                           name="keep_processed_images" {{ 'checked' if settings.keep_processed_images else '' }}>
                                    <label class="form-check-label" for="keep_processed_images">
                                        Keep Processed Images
                                    </label>
                                    <div class="form-text">Save preprocessed images for debugging</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Storage Options -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-database me-2"></i>Data Storage & Logging
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="save_raw_text" 
                                           name="save_raw_text" {{ 'checked' if settings.save_raw_text else '' }}>
                                    <label class="form-check-label" for="save_raw_text">
                                        Save Raw OCR Text
                                    </label>
                                    <div class="form-text">Store complete extracted text for review</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_file_size_mb" class="form-label">Maximum File Size (MB)</label>
                                    <input type="number" class="form-control" id="max_file_size_mb" 
                                           name="max_file_size_mb" value="{{ settings.max_file_size_mb }}" 
                                           min="1" max="500">
                                    <div class="form-text">Maximum allowed file size for uploads</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Interface Options -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-desktop me-2"></i>User Interface Options
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="show_editable_preview" 
                                           name="show_editable_preview" {{ 'checked' if settings.show_editable_preview else '' }}>
                                    <label class="form-check-label" for="show_editable_preview">
                                        Show Editable Preview
                                    </label>
                                    <div class="form-text">Allow users to review and edit extracted data</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="highlight_low_confidence" 
                                           name="highlight_low_confidence" {{ 'checked' if settings.highlight_low_confidence else '' }}>
                                    <label class="form-check-label" for="highlight_low_confidence">
                                        Highlight Low Confidence Fields
                                    </label>
                                    <div class="form-text">Visually mark fields with low confidence scores</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="auto_populate_forms" 
                                           name="auto_populate_forms" {{ 'checked' if settings.auto_populate_forms else '' }}>
                                    <label class="form-check-label" for="auto_populate_forms">
                                        Auto-populate Forms
                                    </label>
                                    <div class="form-text">
                                        <strong>⚠️ Use with caution:</strong> Automatically fill forms without user confirmation
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Monitoring -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Performance Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-microchip fa-2x text-primary mb-2"></i>
                                    <h6>CPU Cores</h6>
                                    <p class="mb-0">Available for processing</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-memory fa-2x text-info mb-2"></i>
                                    <h6>Memory</h6>
                                    <p class="mb-0">Available for large files</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-hdd fa-2x text-success mb-2"></i>
                                    <h6>Storage</h6>
                                    <p class="mb-0">For document archives</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <i class="fas fa-tachometer-alt fa-2x text-warning mb-2"></i>
                                    <h6>Processing Speed</h6>
                                    <p class="mb-0">Typical: 2-5 sec/page</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Save OCR Settings
                    </button>
                </div>
            </form>

            <!-- Test Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-flask me-2"></i>Test OCR Engine
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Upload a test document to verify OCR configuration</p>
                    <a href="{{ url_for('ocr.test_page') }}" class="btn btn-outline-primary">
                        <i class="fas fa-play me-2"></i>Run OCR Test
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show warning when auto-populate is enabled
    const autoPopulateCheckbox = document.getElementById('auto_populate_forms');
    autoPopulateCheckbox.addEventListener('change', function() {
        if (this.checked) {
            if (!confirm('Auto-populate forms can lead to incorrect data entry if OCR confidence is low. Are you sure you want to enable this feature?')) {
                this.checked = false;
            }
        }
    });

    // Update confidence threshold display
    const confidenceInput = document.getElementById('confidence_threshold');
    const confidenceDisplay = document.createElement('span');
    confidenceDisplay.className = 'badge bg-info ms-2';
    confidenceInput.parentNode.appendChild(confidenceDisplay);

    function updateConfidenceDisplay() {
        const value = parseFloat(confidenceInput.value);
        let level = 'Low';
        let className = 'bg-danger';
        
        if (value >= 80) {
            level = 'High';
            className = 'bg-success';
        } else if (value >= 60) {
            level = 'Medium';
            className = 'bg-warning';
        }
        
        confidenceDisplay.textContent = level;
        confidenceDisplay.className = `badge ${className} ms-2`;
    }

    confidenceInput.addEventListener('input', updateConfidenceDisplay);
    updateConfidenceDisplay(); // Initial call
});
</script>
{% endblock %}