{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-clipboard-check me-2"></i>{{ title }}</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Inspection Workflow:</strong> Log the inspection results for received materials. Only passed quantities will be added to inventory.
                        </div>

                        <!-- Source Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.purchase_order_id.label(class="form-label") }}
                                    {{ form.purchase_order_id(class="form-select", id="poSelect") }}
                                    {% for error in form.purchase_order_id.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.job_work_id.label(class="form-label") }}
                                    {{ form.job_work_id(class="form-select", id="jobSelect") }}
                                    {% for error in form.job_work_id.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Item Selection -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form.item_id.label(class="form-label") }}
                                    {{ form.item_id(class="form-select", id="itemSelect") }}
                                    {% for error in form.item_id.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                    <div class="form-text" id="itemHelp">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Select a Purchase Order or Job Work above to automatically load available items.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quantity Fields -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.received_quantity.label(class="form-label") }}
                                    {{ form.received_quantity(class="form-control", step="0.01", id="receivedQty") }}
                                    {% for error in form.received_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.inspected_quantity.label(class="form-label") }}
                                    {{ form.inspected_quantity(class="form-control", step="0.01", id="inspectedQty") }}
                                    {% for error in form.inspected_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.passed_quantity.label(class="form-label") }}
                                    {{ form.passed_quantity(class="form-control", step="0.01", id="passedQty") }}
                                    {% for error in form.passed_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Rejection -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form.rejected_quantity.label(class="form-label") }}
                                    {{ form.rejected_quantity(class="form-control", step="0.01", id="rejectedQty", readonly=true) }}
                                    <div class="form-text">Auto-calculated: Inspected Quantity - Passed Quantity</div>
                                    {% for error in form.rejected_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Summary Display -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-secondary">
                                    <h6><i class="fas fa-calculator me-2"></i>Inspection Summary:</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Acceptance Rate:</strong> <span id="acceptanceRate">0.0%</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Rejection Rate:</strong> <span id="rejectionRate">0.0%</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Total Accounted:</strong> <span id="totalAccounted">0.0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rejection Details -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form.rejection_reasons.label(class="form-label") }}
                                    {{ form.rejection_reasons(class="form-control", rows="3") }}
                                    <div class="form-text">Describe reasons for rejecting materials (scratches, dents, corrosion, quality issues, etc.)</div>
                                    {% for error in form.rejection_reasons.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            {{ form.inspection_notes.label(class="form-label") }}
                            {{ form.inspection_notes(class="form-control", rows="4") }}
                            {% for error in form.inspection_notes.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('material_inspection.dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Log Inspection & Update Inventory
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const receivedQty = document.getElementById('receivedQty');
    const inspectedQty = document.getElementById('inspectedQty');
    const passedQty = document.getElementById('passedQty');
    const damagedQty = document.getElementById('damagedQty');
    const rejectedQty = document.getElementById('rejectedQty');
    const poSelect = document.getElementById('poSelect');
    const jobSelect = document.getElementById('jobSelect');

    // Function to calculate and update summary
    function updateSummary() {
        const received = parseFloat(receivedQty.value) || 0;
        const inspected = parseFloat(inspectedQty.value) || 0;
        const passed = parseFloat(passedQty.value) || 0;
        
        // Only auto-calculate rejected quantity if both inspected AND passed quantities are provided
        let rejected = 0;
        if (inspected > 0 && passedQty.value !== '') {
            rejected = Math.max(0, inspected - passed);
            rejectedQty.value = rejected.toFixed(2);
        } else if (passedQty.value === '') {
            // Clear rejected quantity if passed quantity is not yet entered
            rejectedQty.value = '';
        } else {
            rejected = parseFloat(rejectedQty.value) || 0;
        }

        const totalAccounted = passed + rejected;
        const acceptanceRate = inspected > 0 ? (passed / inspected * 100) : 0;
        const rejectionRate = inspected > 0 ? (rejected / inspected * 100) : 0;

        document.getElementById('acceptanceRate').textContent = acceptanceRate.toFixed(1) + '%';
        document.getElementById('rejectionRate').textContent = rejectionRate.toFixed(1) + '%';
        document.getElementById('totalAccounted').textContent = totalAccounted.toFixed(2);
    }

    // Mutual exclusion for PO and Job Work selection
    poSelect.addEventListener('change', function() {
        if (this.value && this.value !== '0') {
            jobSelect.value = '0';
            loadPOItems(this.value);
        } else {
            clearItemSelect();
        }
    });

    jobSelect.addEventListener('change', function() {
        if (this.value && this.value !== '0') {
            poSelect.value = '0';
            loadJobWorkItems(this.value);
        } else {
            clearItemSelect();
        }
    });
    
    // Function to load PO items
    function loadPOItems(poId) {
        const itemSelect = document.getElementById('itemSelect');
        const itemHelp = document.getElementById('itemHelp');
        
        // Show loading state
        itemSelect.innerHTML = '<option value="">Loading items...</option>';
        itemSelect.disabled = true;
        
        fetch(`/inspection/api/po_items/${poId}`)
            .then(response => response.json())
            .then(data => {
                itemSelect.innerHTML = '<option value="">Select Item from Purchase Order</option>';
                
                if (data.success && data.items.length > 0) {
                    data.items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.item_id;
                        option.textContent = `${item.item_code} - ${item.item_name} (Ordered: ${item.quantity})`;
                        itemSelect.appendChild(option);
                    });
                    itemHelp.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>Items loaded from selected Purchase Order.';
                } else {
                    itemHelp.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>No items found in selected Purchase Order.';
                }
                itemSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error loading PO items:', error);
                itemSelect.innerHTML = '<option value="">Error loading items</option>';
                itemHelp.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-1"></i>Error loading items from Purchase Order.';
                itemSelect.disabled = false;
            });
    }
    
    // Function to load Job Work items
    function loadJobWorkItems(jobId) {
        const itemSelect = document.getElementById('itemSelect');
        const itemHelp = document.getElementById('itemHelp');
        
        // Show loading state
        itemSelect.innerHTML = '<option value="">Loading items...</option>';
        itemSelect.disabled = true;
        
        fetch(`/inspection/api/job_items/${jobId}`)
            .then(response => response.json())
            .then(data => {
                itemSelect.innerHTML = '<option value="">Select Item from Job Work</option>';
                
                if (data.success && data.items.length > 0) {
                    data.items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.item_id;
                        option.textContent = `${item.item_code} - ${item.item_name} (Sent: ${item.quantity})`;
                        itemSelect.appendChild(option);
                    });
                    itemHelp.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>Items loaded from selected Job Work.';
                } else {
                    itemHelp.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>No items found in selected Job Work.';
                }
                itemSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error loading Job Work items:', error);
                itemSelect.innerHTML = '<option value="">Error loading items</option>';
                itemHelp.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-1"></i>Error loading items from Job Work.';
                itemSelect.disabled = false;
            });
    }
    
    // Function to clear item selection
    function clearItemSelect() {
        const itemSelect = document.getElementById('itemSelect');
        const itemHelp = document.getElementById('itemHelp');
        
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = false;
        itemHelp.innerHTML = '<i class="fas fa-info-circle me-1"></i>Select a Purchase Order or Job Work above to automatically load available items.';
    }

    // Add event listeners for calculations
    [receivedQty, inspectedQty, passedQty].forEach(element => {
        element.addEventListener('input', updateSummary);
    });

    // Initial calculation
    updateSummary();
    
    // Auto-load items if PO or Job Work is pre-selected
    const initialPOSelection = poSelect.value;
    const initialJobSelection = jobSelect.value;
    
    if (initialPOSelection && initialPOSelection !== '0') {
        loadPOItems(initialPOSelection);
    } else if (initialJobSelection && initialJobSelection !== '0') {
        loadJobWorkItems(initialJobSelection);
    }
});
</script>
{% endblock %}