{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-clipboard-check me-2"></i>{{ title }}</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Inspection Workflow:</strong> Log the inspection results for received materials. Only passed quantities will be added to inventory.
                        </div>

                        <!-- Source Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.purchase_order_id.label(class="form-label") }}
                                    {{ form.purchase_order_id(class="form-select", id="poSelect") }}
                                    {% for error in form.purchase_order_id.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.job_work_id.label(class="form-label") }}
                                    {{ form.job_work_id(class="form-select", id="jobSelect") }}
                                    {% for error in form.job_work_id.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Item Selection -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form.item_id.label(class="form-label") }}
                                    {{ form.item_id(class="form-select") }}
                                    {% for error in form.item_id.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Quantity Fields -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.received_quantity.label(class="form-label") }}
                                    {{ form.received_quantity(class="form-control", step="0.01", id="receivedQty") }}
                                    {% for error in form.received_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.inspected_quantity.label(class="form-label") }}
                                    {{ form.inspected_quantity(class="form-control", step="0.01", id="inspectedQty") }}
                                    {% for error in form.inspected_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.passed_quantity.label(class="form-label") }}
                                    {{ form.passed_quantity(class="form-control", step="0.01", id="passedQty") }}
                                    {% for error in form.passed_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Rejection -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form.rejected_quantity.label(class="form-label") }}
                                    {{ form.rejected_quantity(class="form-control", step="0.01", id="rejectedQty") }}
                                    <div class="form-text">Any materials that failed inspection (damaged, defective, or don't meet quality standards)</div>
                                    {% for error in form.rejected_quantity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Summary Display -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-secondary">
                                    <h6><i class="fas fa-calculator me-2"></i>Inspection Summary:</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Acceptance Rate:</strong> <span id="acceptanceRate">0.0%</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Rejection Rate:</strong> <span id="rejectionRate">0.0%</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Total Accounted:</strong> <span id="totalAccounted">0.0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rejection Details -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form.rejection_reasons.label(class="form-label") }}
                                    {{ form.rejection_reasons(class="form-control", rows="3") }}
                                    <div class="form-text">Describe reasons for rejecting materials (scratches, dents, corrosion, quality issues, etc.)</div>
                                    {% for error in form.rejection_reasons.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            {{ form.inspection_notes.label(class="form-label") }}
                            {{ form.inspection_notes(class="form-control", rows="4") }}
                            {% for error in form.inspection_notes.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('material_inspection.dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Log Inspection & Update Inventory
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const receivedQty = document.getElementById('receivedQty');
    const inspectedQty = document.getElementById('inspectedQty');
    const passedQty = document.getElementById('passedQty');
    const damagedQty = document.getElementById('damagedQty');
    const rejectedQty = document.getElementById('rejectedQty');
    const poSelect = document.getElementById('poSelect');
    const jobSelect = document.getElementById('jobSelect');

    // Function to calculate and update summary
    function updateSummary() {
        const received = parseFloat(receivedQty.value) || 0;
        const inspected = parseFloat(inspectedQty.value) || 0;
        const passed = parseFloat(passedQty.value) || 0;
        const damaged = parseFloat(damagedQty.value) || 0;
        const rejected = parseFloat(rejectedQty.value) || 0;

        const totalAccounted = passed + damaged + rejected;
        const acceptanceRate = inspected > 0 ? (passed / inspected * 100) : 0;
        const damageRate = inspected > 0 ? (damaged / inspected * 100) : 0;
        const rejectionRate = inspected > 0 ? (rejected / inspected * 100) : 0;

        document.getElementById('acceptanceRate').textContent = acceptanceRate.toFixed(1) + '%';
        document.getElementById('damageRate').textContent = damageRate.toFixed(1) + '%';
        document.getElementById('rejectionRate').textContent = rejectionRate.toFixed(1) + '%';
        document.getElementById('totalAccounted').textContent = totalAccounted.toFixed(2);
        
        // Auto-populate inspected quantity if not set
        if (received > 0 && inspected === 0) {
            inspectedQty.value = received.toFixed(2);
        }
    }

    // Mutual exclusion for PO and Job Work selection
    poSelect.addEventListener('change', function() {
        if (this.value && this.value !== '0') {
            jobSelect.value = '0';
        }
    });

    jobSelect.addEventListener('change', function() {
        if (this.value && this.value !== '0') {
            poSelect.value = '0';
        }
    });

    // Add event listeners for calculations
    [receivedQty, inspectedQty, passedQty, damagedQty, rejectedQty].forEach(element => {
        element.addEventListener('input', updateSummary);
    });

    // Initial calculation
    updateSummary();
});
</script>
{% endblock %}