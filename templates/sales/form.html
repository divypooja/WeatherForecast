{% extends "base.html" %}

{% block title %}{{ title }} - Factory Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-chart-line"></i> {{ title }}</h1>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('sales.list_sales_orders') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Sales Orders
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Sales Order Details</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.so_number.label(class="form-label") }}
                                {{ form.so_number(class="form-control") }}
                                {% if form.so_number.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.so_number.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.customer_id.label(class="form-label") }}
                                {{ form.customer_id(class="form-select") }}
                                {% if form.customer_id.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.customer_id.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.order_date.label(class="form-label") }}
                                {{ form.order_date(class="form-control") }}
                                {% if form.order_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.order_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.delivery_date.label(class="form-label") }}
                                {{ form.delivery_date(class="form-control") }}
                                {% if form.delivery_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.delivery_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Additional SO Fields -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.payment_terms.label(class="form-label") }}
                                {{ form.payment_terms(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.freight_terms.label(class="form-label") }}
                                {{ form.freight_terms(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.validity_months.label(class="form-label") }}
                                {{ form.validity_months(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-control") }}
                                {% if form.status.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.status.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle text-info"></i> 
                                    <strong>Note:</strong> Changing status to "Confirmed" will automatically deduct inventory quantities.
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.delivery_notes.label(class="form-label") }}
                                {{ form.delivery_notes(class="form-control", rows="2") }}
                            </div>
                        </div>
                        
                        <!-- Approval Section -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.prepared_by.label(class="form-label") }}
                                {{ form.prepared_by(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.verified_by.label(class="form-label") }}
                                {{ form.verified_by(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.approved_by.label(class="form-label") }}
                                {{ form.approved_by(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows="3", placeholder="Special terms and conditions...") }}
                            {% if form.notes.errors %}
                                <div class="text-danger small">
                                    {% for error in form.notes.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('sales.list_sales_orders') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> {{ 'Update' if so else 'Save' }} Sales Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Order Items Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Sales Order Items</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addSOItem()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="soItemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%">No.</th>
                                    <th style="width: 10%">Item Code</th>
                                    <th style="width: 25%">Item + Description</th>
                                    <th style="width: 15%">Specification</th>
                                    <th style="width: 10%">HSN Code</th>
                                    <th style="width: 8%">GST Rate</th>
                                    <th style="width: 7%">UOM</th>
                                    <th style="width: 8%">Qty</th>
                                    <th style="width: 10%">Rate</th>
                                    <th style="width: 12%">Amount</th>
                                    <th style="width: 5%">Action</th>
                                </tr>
                            </thead>
                            <tbody id="soItemsBody">
                                {% if so_items %}
                                    {% for item in so_items %}
                                    <tr data-item-id="{{ item.id }}">
                                        <td>{{ loop.index }}</td>
                                        <td>{{ item.item.code }}</td>
                                        <td>{{ item.item.name }}<br><small class="text-muted">{{ item.item.description }}</small></td>
                                        <td>{{ item.item.specification or '-' }}</td>
                                        <td>{{ item.item.hsn_code or '-' }}</td>
                                        <td>{{ item.item.gst_rate or 18.0 }}%</td>
                                        <td>{{ item.item.unit_of_measure }}</td>
                                        <td>{{ item.quantity_ordered }}</td>
                                        <td>₹{{ item.unit_price }}</td>
                                        <td>₹{{ item.total_price }}</td>
                                        <td>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeSOItem({{ item.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            </tbody>
                            <tfoot>
                                <tr class="table-secondary">
                                    <td colspan="9" class="text-end"><strong>Sub Total:</strong></td>
                                    <td><span id="subTotal">₹0.00</span></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% if not so_items %}
                        <div class="text-center py-4">
                            <p class="text-muted mb-0">No items added yet. Click "Add Item" to get started.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let itemCounter = 0;

// Define items data for JavaScript use
const itemsData = [
    {% for item in items %}
    {
        id: {{ item.id }},
        code: "{{ item.code }}",
        name: "{{ item.name }}",
        description: "{{ item.description or '' }}",
        hsn_code: "{{ item.hsn_code or '' }}",
        gst_rate: {{ item.gst_rate or 18.0 }},
        unit_of_measure: "{{ item.unit_of_measure }}",
        unit_price: {{ item.unit_price or 0.0 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

function addSOItem() {
    itemCounter++;
    const tbody = document.getElementById('soItemsBody');
    const rowCount = tbody.rows.length + 1;
    
    const row = tbody.insertRow();
    row.innerHTML = `
        <td>${rowCount}</td>
        <td>
            <input type="text" class="form-control form-control-sm" name="item_code_new_${itemCounter}" placeholder="Item Code" readonly>
        </td>
        <td>
            <select class="form-control form-control-sm" name="item_id_new_${itemCounter}" onchange="populateSOItemDetails(this)">
                <option value="">Select Item</option>
            </select>
            <textarea class="form-control form-control-sm mt-1" name="description_new_${itemCounter}" 
                      rows="2" placeholder="Item description" readonly></textarea>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="specification_new_${itemCounter}" placeholder="Specification">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="hsn_code_new_${itemCounter}" placeholder="HSN Code" readonly>
        </td>
        <td>
            <div class="input-group">
                <input type="number" class="form-control form-control-sm" name="gst_rate_new_${itemCounter}" 
                       step="0.01" min="0" max="100" placeholder="18" readonly>
                <span class="input-group-text">%</span>
            </div>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="uom_new_${itemCounter}" placeholder="UOM" readonly>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="qty_new_${itemCounter}" 
                   step="0.01" min="0" onchange="calculateSOAmount(this)" placeholder="0">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="rate_new_${itemCounter}" 
                   step="0.01" min="0" onchange="calculateSOAmount(this)" placeholder="0.00">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="amount_new_${itemCounter}" 
                   readonly placeholder="0.00">
        </td>
        <td>
            <button type="button" class="btn btn-success btn-sm me-1" onclick="saveSOItem(this.closest('tr'))" title="Save Item">
                <i class="fas fa-save"></i>
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeSORow(this)" title="Remove Row">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    // Populate the item dropdown
    const selectElement = row.querySelector('select[name*="item_id"]');
    itemsData.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = `${item.code} - ${item.name}`;
        option.dataset.code = item.code;
        option.dataset.name = item.name;
        option.dataset.description = item.description;
        option.dataset.hsn = item.hsn_code;
        option.dataset.gst = item.gst_rate;
        option.dataset.uom = item.unit_of_measure;
        option.dataset.price = item.unit_price;
        selectElement.appendChild(option);
    });
    
    // Remove "no items" message if it exists
    const noItemsMessage = document.querySelector('.text-center.py-4');
    if (noItemsMessage) {
        noItemsMessage.remove();
    }
}

function populateSOItemDetails(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    
    if (selectedOption.value) {
        const row = selectElement.closest('tr');
        
        // Find all input fields in this row
        const itemCodeInput = row.querySelector(`input[name*="item_code"]`);
        const descriptionTextarea = row.querySelector(`textarea[name*="description"]`);
        const hsnInput = row.querySelector(`input[name*="hsn_code"]`);
        const gstInput = row.querySelector(`input[name*="gst_rate"]`);
        const uomInput = row.querySelector(`input[name*="uom"]`);
        const rateInput = row.querySelector(`input[name*="rate"]`);
        
        // Populate the fields
        if (itemCodeInput) itemCodeInput.value = selectedOption.dataset.code || '';
        if (descriptionTextarea) descriptionTextarea.value = selectedOption.dataset.description || '';
        if (hsnInput) hsnInput.value = selectedOption.dataset.hsn || '';
        if (gstInput) gstInput.value = selectedOption.dataset.gst || '18';
        if (uomInput) uomInput.value = selectedOption.dataset.uom || '';
        if (rateInput) rateInput.value = selectedOption.dataset.price || '0.00';
        
        // Calculate amount if quantity is already entered
        calculateSOAmount(rateInput);
    }
}

function calculateSOAmount(inputElement) {
    const row = inputElement.closest('tr');
    const qtyInput = row.querySelector(`input[name*="qty"]`);
    const rateInput = row.querySelector(`input[name*="rate"]`);
    const amountInput = row.querySelector(`input[name*="amount"]`);
    
    if (qtyInput && rateInput && amountInput) {
        const qty = parseFloat(qtyInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const amount = qty * rate;
        amountInput.value = amount.toFixed(2);
        
        // Update subtotal
        updateSOSubTotal();
    }
}

function updateSOSubTotal() {
    const amountInputs = document.querySelectorAll('#soItemsTable input[name*="amount"]');
    let subTotal = 0;
    
    amountInputs.forEach(input => {
        subTotal += parseFloat(input.value) || 0;
    });
    
    const subTotalElement = document.getElementById('subTotal');
    if (subTotalElement) {
        subTotalElement.textContent = `₹${subTotal.toFixed(2)}`;
    }
}

function removeSORow(button) {
    const row = button.closest('tr');
    row.remove();
    
    // Update row numbers
    const tbody = document.getElementById('soItemsBody');
    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        row.cells[0].textContent = index + 1;
    });
    
    // Update subtotal
    updateSOSubTotal();
    
    // Show "no items" message if table is empty
    if (rows.length === 0) {
        const tableContainer = document.querySelector('#soItemsTable').closest('.card-body');
        const noItemsDiv = document.createElement('div');
        noItemsDiv.className = 'text-center py-4';
        noItemsDiv.innerHTML = '<p class="text-muted mb-0">No items added yet. Click "Add Item" to get started.</p>';
        tableContainer.appendChild(noItemsDiv);
    }
}

function removeSOItem(itemId) {
    if (confirm('Are you sure you want to remove this item?')) {
        // Make AJAX call to remove the item from the database
        fetch(`/sales/remove_item/${itemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                if (row) {
                    row.remove();
                    updateSOSubTotal();
                    // Show success message
                    showMessage(data.message, 'success');
                }
            } else {
                showMessage(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error removing item', 'danger');
        });
    }
}

function saveSOItem(row) {
    const selectElement = row.querySelector('select[name*="item_id"]');
    const qtyInput = row.querySelector('input[name*="qty"]');
    const rateInput = row.querySelector('input[name*="rate"]');
    
    if (!selectElement.value || !qtyInput.value || !rateInput.value) {
        showMessage('Please fill in all required fields (Item, Quantity, Rate)', 'warning');
        return;
    }
    
    // Get SO ID from the form or URL
    const soId = getSalesOrderId();
    if (!soId) {
        showMessage('Sales Order must be saved first before adding items', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('item_id', selectElement.value);
    formData.append('quantity', qtyInput.value);
    formData.append('unit_price', rateInput.value);
    
    fetch(`/sales/add_item/${soId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Reload the page to show the saved item
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error saving item', 'danger');
    });
}

function getSalesOrderId() {
    // Extract SO ID from URL path
    const pathParts = window.location.pathname.split('/');
    const editIndex = pathParts.indexOf('edit');
    if (editIndex !== -1 && editIndex + 1 < pathParts.length) {
        return pathParts[editIndex + 1];
    }
    return null;
}

function showMessage(message, type) {
    // Create and show a Bootstrap alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the main content
    const mainContent = document.querySelector('.container-fluid');
    mainContent.insertBefore(alertDiv, mainContent.firstChild);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Calculate initial subtotal on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSOSubTotal();
});
</script>

{% endblock %}
